<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>URL Shortener Admin Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
</head>
<body class="bg-light">
  <div class="container py-4">
    <h1 class="mb-4">URL Shortener Admin Dashboard</h1>

    <div class="card mb-4">
      <div class="card-body d-flex gap-3 align-items-end">
        <div class="flex-grow-1">
          <label class="form-label">Admin Key</label>
          <input id="adminKey" type="password" class="form-control" placeholder="Enter Admin Key" />
        </div>
        <button id="btnLoadAccounts" class="btn btn-primary">Load Accounts</button>
      </div>
    </div>

    <div class="card mb-4">
      <div class="card-header d-flex justify-content-between align-items-center">
        <strong>Accounts</strong>
        <button id="btnCreateAccount" class="btn btn-sm btn-success">Create Account</button>
      </div>
      <div class="card-body p-0">
        <table class="table table-striped mb-0" id="accountsTable">
          <thead><tr><th>ID</th><th>Name</th><th></th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <div class="card mb-4" id="urlsCard" style="display:none;">
      <div class="card-header d-flex justify-content-between align-items-center">
        <strong>URLs for Account <span id="selectedAccountName"></span></strong>
        <button id="btnRefreshUrls" class="btn btn-sm btn-outline-secondary">Refresh</button>
      </div>
      <div class="card-body p-0">
        <table class="table table-striped mb-0" id="urlsTable">
          <thead><tr><th>Alias</th><th>ShortID</th><th>Destination</th><th>Total Clicks</th><th>Last Click</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <div id="notice" class="alert alert-info d-none"></div>
  </div>

<script>
  const BASE_HOST = window.location.origin;
  const adminKeyInput = document.getElementById('adminKey');
  const noticeBox = document.getElementById('notice');
  document.getElementById('btnLoadAccounts').onclick = loadAccounts;
  document.getElementById('btnCreateAccount').onclick = createAccount;
  document.getElementById('btnRefreshUrls').onclick = () => loadUrls(currentAccount.id);

  let currentAccount = null;

  function showNotice(msg) {
    noticeBox.textContent = msg;
    noticeBox.classList.remove('d-none');
    setTimeout(()=> noticeBox.classList.add('d-none'), 3000);
  }

  async function loadAccounts() {
    const adminKey = adminKeyInput.value;
    const res = await fetch(`${BASE_HOST}/admin/accounts`, { headers: { 'X-ADMIN-KEY': adminKey }});
    const data = await res.json();
    const tbody = document.querySelector('#accountsTable tbody');
    tbody.innerHTML = '';
    if (data.accounts) {
      data.accounts.forEach(a => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${a.id}</td><td>${a.name}</td><td><button class="btn btn-sm btn-outline-primary">View URLs</button></td>`;
        tr.querySelector('button').onclick = () => selectAccount(a);
        tbody.appendChild(tr);
      });
    } else showNotice('Failed to load accounts');
  }

  function selectAccount(account) {
    currentAccount = account;
    document.getElementById('selectedAccountName').textContent = `${account.name} (#${account.id})`;
    document.getElementById('urlsCard').style.display = 'block';
    loadUrls(account.id);
  }

  async function loadUrls(accountId) {
    const adminKey = adminKeyInput.value;
    const res = await fetch(`${BASE_HOST}/admin/urls?account=${accountId}`, { headers: { 'X-ADMIN-KEY': adminKey }});
    const data = await res.json();
    const tbody = document.querySelector('#urlsTable tbody');
    tbody.innerHTML = '';
    if (data.urls) {
      data.urls.forEach(u => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${u.alias}</td><td>${u.shortid}</td><td>${u.destination}</td><td>${u.total_clicks}</td><td>${u.last_click_at || ''}</td>`;
        tbody.appendChild(tr);
      });
    }
  }

  async function createAccount() {
    const name = prompt('Account name?');
    if (!name) return;
    const adminKey = adminKeyInput.value;
    const res = await fetch(`${BASE_HOST}/admin/accounts`, {
      method: 'POST',
      headers: { 'X-ADMIN-KEY': adminKey, 'Content-Type': 'application/json' },
      body: JSON.stringify({ name })
    });
    const data = await res.json();
    if (data.accountId) { showNotice('Account created'); loadAccounts(); }
    else showNotice('Failed to create');
  }
</script>
</body>
</html>